<!DOCTYPE html>

<html>

<head>
<style>
#info {
  position: absolute;
  top: 0px;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ff0000;
}

body {
  overflow: hidden;
}
</style>
</head>

<body> 
<div id="info">
  homework5
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/95/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>
<script src="https://rawgit.com/mrdoob/three.js/dev/examples/js/Gyroscope.js"></script>
<script src="https://rawgit.com/mrdoob/three.js/dev/examples/js/MorphBlendMesh.js"></script>
<script src="https://rawgit.com/mrdoob/three.js/dev/examples/js/MD2CharacterComplex.js"></script>
<script src="https://rawgit.com/mrdoob/three.js/dev/examples/js/loaders/MD2Loader.js"></script>
<script>
class MD2Wrapper{
	constructor (config, controls, pos, scale = 1){
	
		this.md2 = new THREE.MD2CharacterComplex();
		this.md2.scale = scale;
		this.md2.controls = controls;
		
		this.md2.onLoadComplete = function(){
			this.enableShadows(true);
			this.setWeapon(0);
			this.setSkin(0);
			
			this.root.position.x = pos.x;
			this.root.position.z = pos.z;
			
			console.log ('y is ' + this.root.position.y)
			
			scene.add(this.root);
		}
		this.md2.loadParts(config);
	}
}


var scene, light, camera, renderer, controls;
var keyboard = new KeyboardState();
var vegetaWrap;
var box3, box3Helper;
var clock = new THREE.Clock();

init();
animate();


function init() {
  renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x888888);
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
  camera.position.y = 50;
  camera.position.z = 80;

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableKeys = false;
  ///// Light
  light = new THREE.DirectionalLight(0xffffff);
  light.position.set(0, 100, 150);
  scene.add(light);
  light.castShadow = true;
  light.shadow.mapSize.width = 1024;
  light.shadow.mapSize.height = 1024;
  light.shadow.camera.near = 100;
  light.shadow.camera.far = 1200;
  light.shadow.camera.left = -1000;
  light.shadow.camera.right = 1000;
  light.shadow.camera.top = 350;
  light.shadow.camera.bottom = -350;
  light.shadow.camera.fov = light.angle / Math.PI * 180 *2;
  light.shadow.bias = -0.01;
  scene.add( new THREE.CameraHelper( light.shadow.camera ) );
  ambientLight = new THREE.AmbientLight(0x444444);
  scene.add(ambientLight);
	
  var gridXZ = new THREE.GridHelper(1000, 100, 'red', 'white');
  scene.add(gridXZ);
  ///// Ground
  var ground = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshPhongMaterial());
  ground.receiveShadow = true;
  ground.rotation.x = -Math.PI/2;
  ground.position.y -= 1;
  scene.add(ground);
  
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  
  ///// Character
  
  let configVegeta = {
	baseUrl: "md2models/vegeta/",
	
	body: "tris.md2",
	skins: ["ssvegeta.png"],
	weapons:  [["w_bfg.md2", "w_bfg.png"]],

	animations: {
		move: "run",
		idle: "stand",
		jump: "jump",
		attack: "attack",
		crouchMove: "crwalk",
		crouchIdle: "crstnd",
		crouchAttach: "crattak"
	},

	walkSpeed: 350, 
	crouchSpeed: 175

	}
	let characterControls = {
		
		moveForward: false,
		moveBackward: false,
		moveLeft: false,
		moveRight: false
	};
	vegetaWrap = new MD2Wrapper(configVegeta, characterControls, new THREE.Vector3(0, 0, 0), 1);
	
	var gyro = new THREE.Gyroscope();
	gyro.add(camera);
	gyro.add(light, light.target);
	vegetaWrap.md2.root.add(gyro);
	
	box3 = new THREE.Box3();
	box3helper = new THREE.Box3Helper(box3);
	scene.add(box3helper);
	
	window.addEventListener( 'resize', onWindowResize, false );
	document.addEventListener( 'keydown', onKeyDown, false );
	document.addEventListener( 'keyup', onKeyUp, false );
}

function animate() {
  requestAnimationFrame(animate);
  render();
}

function render() {
	box3.setFromObject(vegetaWrap.md2.root);
	let delta = clock.getDelta();
	if(vegetaWrap.md2){
		vegetaWrap.md2.update(delta);
	}
  renderer.render(scene, camera);
}
function onKeyDown(event){
	event.stopPropagation();
	let controls = vegetaWrap.md2.controls;
	
	switch( event.keyCode ){
		case 38: /*up*/
		case 87: /*W*/ 	controls.moveForward = true; break;
		case 40: /*down*/
		case 83: /*S*/ 	 controls.moveBackward = true; break;
		case 37: /*left*/
		case 65: /*A*/ controls.moveLeft = true; break;
		case 39: /*right*/
		case 68: /*D*/ controls.moveRight = true; break;
		case 67: /*C*/     controls.crouch = true; break;
		case 32: /*space*/ controls.jump = true; break;
		case 17: /*ctrl*/  controls.attack = true; break;
	}
}
function onKeyUp( event ) {
	event.stopPropagation();
	let controls = vegetaWrap.md2.controls;
	switch ( event.keyCode ) {
		case 38: /*up*/
		case 87: /*W*/ controls.moveForward = false; break;
		case 40: /*down*/
		case 83: /*S*/ 	 controls.moveBackward = false; break;
		case 37: /*left*/
		case 65: /*A*/ 	 controls.moveLeft = false; break;
		case 39: /*right*/
		case 68: /*D*/ controls.moveRight = false; break;
		case 67: /*C*/     controls.crouch = false; break;
		case 32: /*space*/ controls.jump = false; break;
		case 17: /*ctrl*/  controls.attack = false; break;
	}
}

function onWindowResize() {
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize( window.innerWidth, window.innerHeight );
}


</script>
</body>

</html>